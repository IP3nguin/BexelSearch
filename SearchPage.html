<!DOCTYPE html>
<html>
<head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <!-- load jquery -->
        <script src="https://www.gstatic.com/firebasejs/3.5.2/firebase.js"></script>
        <!-- load firebase library -->
        <script>
            // initialise firebase
            var config = {
                apiKey: "AIzaSyCHb_Ra7dl02OImTNyEnLoGek4IA5Ck84g",
                authDomain: "bexel-ed8b3.firebaseapp.com",
                databaseURL: "https://bexel-ed8b3.firebaseio.com",
                storageBucket: "bexel-ed8b3.appspot.com",
                messagingSenderId: "325793789014"
            };
            firebase.initializeApp(config);

        </script>
    
	<h1>Search</h1>
</head>
<body onload="initialise()">

<form id = "searchBox">
  <input type="text" id = "search" name="search" placeholder="Search..">
</form>

<div id="map" style="width: 500px; height: 400px;"></div>
<script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>

</body>
    
    
<script>
 var map;
 var Latlng = new google.maps.LatLng(70.38914, -6.600050); //Default Location
 var classRef = firebase.database().ref('classes');
 var mapRefreshed = false;
 var results=[];
 var titles = [];
 var instructors = [];
 var descriptions = [];
 var emails = [];
 var facebooks = [];
 var twitters = [];
 var phones = [];
 var websites = [];
 var loclat = [];
 var loclong = [];

 function initialise() {
     var mapOptions = {
         zoom: 11,
         center: Latlng,
         mapTypeId: google.maps.MapTypeId.ROADMAP
     };
     var map = new google.maps.Map(document.getElementById('map'), mapOptions); //Create new map

     if (navigator.geolocation) {
         navigator.geolocation.getCurrentPosition(function (position) {
             initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude); //Get User location using GeoLocation API
             map.setCenter(initialLocation); // Refresh map to centre on user location
         });
	}
    if(mapRefreshed){
        var i = 0;
        titles.forEach(function(item){
            var contentString = "<h1>" + titles[i] + "</h1></br>" + descriptions[i] + "</br>";
            var ClassLoc=new google.maps.LatLng(loclat[i], loclong[i]);
            var marker = new google.maps.Marker({
                position: ClassLoc,
                map: map
            });
       
            var infowindow = new google.maps.InfoWindow({
                content: contentString
                });
    
            google.maps.event.addListener( marker, "click", function(e) {
                infoWindow.open(map, marker);
            });
            ++i;
            
        });
        mapRefreshed = false;
    }
    
 }

var searchBox = document.getElementById("searchBox");
    
searchBox.onsubmit = function(search){
    search.preventDefault();
    results=[];
    var i = 0,temp = "";
    
    classRef.orderByChild("ClassTitle").on("value", function(snap){
        snap.forEach(function(item){
        results.push(item.val());
        });
        
    });
    titles = [];
    instructors = [];
    descriptions = [];
    emails = [];
    facebooks = [];
    twitters = [];
    phones = [];
    websites = [];
    loclat = [];
    loclong = [];
         
    var searchString = $("#search").val();
    results.forEach(function(item){
        if(item.ClassTitle === searchString){
            titles.push(item.ClassTitle);
            instructors.push(item.ClassInstructor);
            descriptions.push(item.Description);
            emails.push(item.Email);
            facebooks.push(item.Facebook);
            twitters.push(item.Twitter);
            phones.push(item.Phone);
            websites.push(item.Website);
            loclat.push(item.LocationLat);
            loclong.push(item.LocationLong);
        };
    });
    mapRefreshed = true;
    initialise();
    
    
}
</script>
</html>
